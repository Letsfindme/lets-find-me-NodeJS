{"version":3,"sources":["../../src/controllers/shop.js"],"names":["Product","models","User","exports","getProducts","req","res","next","findAll","products","status","json","console","log","getProduct","prodId","params","productId","findByPk","then","product","render","pageTitle","title","path","err","getIndex","prods","getCart","user","cart","postCart","body","fetchedCart","newQuantity","createCart","map","cartItem","destroy","where","id","addProduct","through","quantity","postCartDeleteProduct","result","postOrder","total","price","credit","error","Error","statusCode","userId","update","createOrder","order","addProducts","orderItem","setProducts","getOrders","include","orders"],"mappings":"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","sourcesContent":["import models from \"../setup/models\";\n\nconst { Product, User } = models;\n\n//User get all products\nexports.getProducts = async (req, res, next) => {\n  try {\n    const products = await Product.findAll();\n    return res.status(200).json(products);\n  } catch (error) {\n    //todo logs\n    console.log(error);\n    next(error);\n  }\n};\n\nexports.getProduct = (req, res, next) => {\n  const prodId = req.params.productId;\n  // Product.findAll({ where: { id: prodId } })\n  //   .then(products => {\n  //     res.render('shop/product-detail', {\n  //       product: products[0],\n  //       pageTitle: products[0].title,\n  //       path: '/products'\n  //     });\n  //   })\n  //   .catch(err => console.log(err));\n  Product.findByPk(prodId)\n    .then((product) => {\n      res.render(\"shop/product-detail\", {\n        product: product,\n        pageTitle: product.title,\n        path: \"/products\",\n      });\n    })\n    .catch((err) => console.log(err));\n};\n\nexports.getIndex = (req, res, next) => {\n  Product.findAll()\n    .then((products) => {\n      res.render(\"shop/index\", {\n        prods: products,\n        pageTitle: \"Shop\",\n        path: \"/\",\n      });\n    })\n    .catch((err) => {\n      console.log(err);\n    });\n};\n\nexports.getCart = (req, res, next) => {\n  req.user\n    .getCart()\n    .then((cart) => {\n      return cart\n        .getProducts()\n        .then((products) => {\n          return res.status(200).json(products);\n        })\n        .catch((err) => console.log(err));\n    })\n    .catch((err) => console.log(err));\n};\n\n// Add item to cart (replace all items)\nexports.postCart = (req, res, next) => {\n  const prodId = req.body.productId;\n  let fetchedCart;\n  let newQuantity = 1;\n  req.user\n    .getCart()\n    .then((cart) => {\n      fetchedCart = cart;\n      //Create carte if it doesn't exist\n      if (!cart) {\n        return req.user.createCart();\n      } else {\n        cart\n          .getProducts()\n          .then((products) =>\n            products.map((product) => product.cartItem.destroy())\n          );\n\n        return cart.getProducts();\n      }\n    })\n    //CASE product already in the cart (for later use)\n    .then((products) => {\n      //CASE product not in the cart\n      //Find products to add them to cart\n      return Product.findAll({\n        where: {\n          id: prodId,\n        },\n      });\n    })\n    .then((products) => {\n      products.map((product) =>\n        //Add each product to cart\n        fetchedCart.addProduct(product, {\n          through: { quantity: newQuantity },\n        })\n      );\n      return products;\n    })\n    .then((products) => {\n      res.status(200).json(products);\n    })\n    .catch((err) => console.log(err));\n};\n\nexports.postCartDeleteProduct = (req, res, next) => {\n  const prodId = req.body.productId;\n  req.user\n    .getCart()\n    .then((cart) => {\n      return cart.getProducts({ where: { id: prodId } });\n    })\n    .then((products) => {\n      const product = products[0];\n      return product.cartItem.destroy();\n    })\n    .then((result) => {\n      res.status(200);\n    })\n    .catch((err) => console.log(err));\n};\n\nexports.postOrder = (req, res, next) => {\n  let fetchedCart;\n  req.user\n    .getCart()\n    .then((cart) => {\n      fetchedCart = cart;\n      return cart.getProducts();\n    })\n    .then((products) => {\n      let total = 0;\n      products.map((product) => (total += product.price));\n      //todo  req.user.credit > products.price\n      //verfiy user credit befor submitting order\n\n      // If user dont have credit\n      if (total > req.user.credit) {\n        const error = new Error(\"User dont have credit\");\n        error.statusCode = 500;\n        throw error;\n      }\n\n      //update user credit\n      User.findByPk(req.userId).then((user) => {\n        if (!user) {\n          const error = new Error(\"Not found.\");\n          error.statusCode = 404;\n          throw error;\n        }\n        return user.update({ credit: req.user.credit - total });\n      });\n\n      return req.user\n        .createOrder()\n        .then((order) => {\n          return order.addProducts(\n            products.map((product) => {\n              product.orderItem = { quantity: product.cartItem.quantity };\n              return product;\n            })\n          );\n        })\n        .catch((err) => console.log(err));\n    })\n    .then((result) => {\n      return fetchedCart.setProducts(null);\n    })\n    .then((result) => {\n      res.status(200).json(result);\n    })\n    .catch((err) => console.log(err));\n};\n\nexports.getOrders = (req, res, next) => {\n  req.user\n    .getOrders({ include: [\"products\"] })\n    .then((orders) => {\n      res.status(200).json({\n        orders: orders,\n        credit:req.user.credit\n      });\n    })\n    .catch((err) => console.log(err));\n};\n"],"file":"shop.js"}